<?xml version="1.0" encoding="utf-8" ?>
<base:BasePage
    x:Class="LonerApp.Features.Pages.ChatPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:base="clr-namespace:LonerApp.Utilities.MVVM"
    xmlns:cardViewControls="clr-namespace:PanCardView.Controls;assembly=PanCardView"
    xmlns:cards="clr-namespace:PanCardView;assembly=PanCardView"
    xmlns:controls="clr-namespace:LonerApp.UI.Controls"
    xmlns:ffimageloading="clr-namespace:FFImageLoading.Maui;assembly=FFImageLoading.Maui"
    xmlns:i18n="clr-namespace:LonerApp.Helpers.Extensions"
    xmlns:models="clr-namespace:LonerApp.Models"
    xmlns:sho="http://sharpnado.com"
    xmlns:swipe="clr-namespace:Plugin.Maui.SwipeCardView;assembly=Plugin.Maui.SwipeCardView"
    xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
    xmlns:vm="clr-namespace:LonerApp.PageModels"
    Title="ChatPage"
    x:DataType="vm:ChatPageModel"
    BackgroundColor="{toolkit:AppThemeResource BackgroundPageColor}"
    NavigationPage.HasNavigationBar="True"
    Shell.NavBarIsVisible="False"
    Shell.TabBarIsVisible="True">
    <Page.Behaviors>
        <toolkit:StatusBarBehavior StatusBarColor="White" StatusBarStyle="DarkContent" />
    </Page.Behaviors>
    <base:BasePage.Resources>
        <ResourceDictionary />
        <DataTemplate x:Key="GetSwipeTemplate">
            <StackLayout Orientation="Vertical" Spacing="2">
                <StackLayout.GestureRecognizers>
                    <TapGestureRecognizer Command="{Binding Source={RelativeSource FindAncestorBindingContext, AncestorType={x:Type vm:ChatPageModel}}, x:DataType={x:Type vm:ChatPageModel}, Path=GetSwipePressedCommand}" />
                </StackLayout.GestureRecognizers>
                <ffimageloading:CachedImage
                    Aspect="AspectFit"
                    DownsampleToViewSize="True"
                    HeightRequest="120"
                    IsOpaque="True"
                    LoadingPriority="Lowest"
                    Source="icon_chat_get_like.png"
                    WidthRequest="100">
                    <ffimageloading:CachedImage.Clip>
                        <RoundRectangleGeometry CornerRadius="10" Rect="0,0,100,120" />
                    </ffimageloading:CachedImage.Clip>
                </ffimageloading:CachedImage>
                <Label
                    FontFamily="GothamBold"
                    FontSize="{StaticResource FontSizeM}"
                    HorizontalOptions="Center"
                    HorizontalTextAlignment="Center"
                    Text="{i18n:Translate Chat_GetLike_Title}"
                    TextColor="{toolkit:AppThemeResource HyperLinkSignUpColor}" />
            </StackLayout>
        </DataTemplate>
        <DataTemplate x:Key="ChatMessageItemTemplate" x:DataType="models:UserChatModel">
            <sho:DraggableViewCell IsDraggable="False">
                <ContentView>
                    <Grid
                        Margin="0"
                        Padding="0"
                        ColumnDefinitions="Auto, *"
                        ColumnSpacing="20"
                        RowDefinitions="*,Auto">
                        <ffimageloading:CachedImage
                            Aspect="AspectFill"
                            DownsampleToViewSize="True"
                            HeightRequest="70"
                            IsOpaque="True"
                            LoadingDelay="0"
                            LoadingPriority="Lowest"
                            Source="{Binding AvatarUrl}"
                            WidthRequest="70">
                            <ffimageloading:CachedImage.Clip>
                                <RoundRectangleGeometry CornerRadius="50" Rect="0,0,70,70" />
                            </ffimageloading:CachedImage.Clip>
                        </ffimageloading:CachedImage>
                        <StackLayout
                            Grid.Column="1"
                            HorizontalOptions="Start"
                            Orientation="Vertical"
                            Spacing="0"
                            VerticalOptions="Center">
                            <Label
                                FontFamily="GothamBold"
                                FontSize="{StaticResource FontSizeM}"
                                HorizontalTextAlignment="Start"
                                Text="{Binding UserName}"
                                TextColor="{toolkit:AppThemeResource HyperLinkSignUpColor}"
                                VerticalTextAlignment="Center" />
                            <Label
                                FontFamily="GothamLight"
                                FontSize="{StaticResource FontSizeM}"
                                HorizontalTextAlignment="Start"
                                LineBreakMode="TailTruncation"
                                MaximumWidthRequest="250"
                                Text="{Binding LastMessage}"
                                TextColor="{toolkit:AppThemeResource HyperLinkSignUpColor}"
                                VerticalTextAlignment="Center" />
                        </StackLayout>
                        <BoxView
                            Grid.Row="1"
                            Grid.Column="1"
                            BackgroundColor="{toolkit:AppThemeResource TextPhoneNumberColor}"
                            HeightRequest="0.5"
                            HorizontalOptions="Fill"
                            Opacity="0.3" />
                    </Grid>
                </ContentView>
            </sho:DraggableViewCell>
        </DataTemplate>
        <DataTemplate x:Key="UserChatItemTemplate" x:DataType="models:UserProfileResponse">
            <StackLayout Orientation="Vertical" Spacing="2">
                <StackLayout.GestureRecognizers>
                    <TapGestureRecognizer Command="{Binding Source={RelativeSource FindAncestorBindingContext, AncestorType={x:Type vm:ChatPageModel}}, x:DataType={x:Type vm:ChatPageModel}, Path=UserChatItemClickedCommand}" CommandParameter="{Binding .}" />
                </StackLayout.GestureRecognizers>
                <ffimageloading:CachedImage
                    Aspect="AspectFill"
                    DownsampleToViewSize="True"
                    HeightRequest="120"
                    IsOpaque="True"
                    LoadingDelay="0"
                    LoadingPriority="Lowest"
                    Source="{Binding AvatarUrl}"
                    WidthRequest="100">
                    <ffimageloading:CachedImage.Clip>
                        <RoundRectangleGeometry CornerRadius="10" Rect="0,0,100,120" />
                    </ffimageloading:CachedImage.Clip>
                </ffimageloading:CachedImage>
                <Label
                    FontFamily="GothamBold"
                    FontSize="{StaticResource FontSizeM}"
                    HorizontalOptions="Center"
                    HorizontalTextAlignment="Center"
                    LineBreakMode="TailTruncation"
                    MaximumWidthRequest="100"
                    Text="{Binding Username}"
                    TextColor="{toolkit:AppThemeResource HyperLinkSignUpColor}" />
            </StackLayout>
        </DataTemplate>
        <vm:UserChatDataTemplateSelector
            x:Key="userChatTempateSelector"
            GetSwipeItemTemplate="{StaticResource GetSwipeTemplate}"
            UserChatItemTemplate="{StaticResource UserChatItemTemplate}" />
    </base:BasePage.Resources>
    <base:BasePage.Content>
        <Grid
            Margin="0"
            Padding="0"
            RowDefinitions="Auto,*">
            <controls:CustomNavigationBar
                BackButtonCommand="{Binding BackCommand}"
                HasBackButton="{Binding HasBackButton}"
                IsVisible="{Binding IsVisibleNavigation}"
                OptionButtonCommand="{Binding SearchPressedCommand}"
                OptionPage="&#xf016;"
                TitlePage="Loner" />
            <Grid
                Grid.Row="1"
                Padding="20,0"
                RowDefinitions="Auto, 10, Auto, 10, Auto,10,Auto,20,Auto,20,*">
                <Grid
                    ColumnDefinitions="*"
                    ColumnSpacing="10"
                    HeightRequest="50"
                    HorizontalOptions="Fill"
                    IsVisible="{Binding IsVisibleFilterContainer}">
                    <Grid>
                        <Border
                            x:Name="InputGrid"
                            Margin="0"
                            Padding="5,0,0,0"
                            Background="Transparent"
                            Stroke="{toolkit:AppThemeResource PrimaryColor}"
                            StrokeShape="RoundRectangle 10"
                            StrokeThickness="2"
                            VerticalOptions="Center">
                            <ContentView Margin="0" Padding="0">
                                <Grid>
                                    <controls:BorderlessEditor
                                        x:Name="AboutMeEditor"
                                        AutoSize="TextChanges"
                                        Focused="AboutMeEditor_Focused"
                                        FontFamily="Gotham"
                                        FontSize="{StaticResource FontSizeM}"
                                        HorizontalOptions="Start"
                                        MaximumHeightRequest="120"
                                        MaximumWidthRequest="250"
                                        Placeholder="Nhập tên người dùng ...                             "
                                        Text="{Binding Source={RelativeSource FindAncestorBindingContext, AncestorType={x:Type vm:ChatPageModel}}, x:DataType={x:Type vm:ChatPageModel}, Path=SearchUserValue, Mode=TwoWay, UpdateSourceEventName=TextChanged}"
                                        TextColor="{toolkit:AppThemeResource TextPhoneNumberColor}"
                                        Unfocused="AboutMeEditor_Unfocused" />
                                    <Label
                                        x:Name="lbSend"
                                        Margin="10,0,10,0"
                                        FontFamily="GothamBold"
                                        FontSize="{StaticResource FontSizeL}"
                                        HorizontalOptions="End"
                                        Text="Tìm"
                                        TextColor="{toolkit:AppThemeResource PrimaryColor}"
                                        VerticalOptions="Center">
                                        <Label.GestureRecognizers>
                                            <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type vm:ChatPageModel}}, Path=SearchUserPressedCommand, x:DataType={x:Type vm:ChatPageModel}}" />
                                        </Label.GestureRecognizers>
                                    </Label>
                                </Grid>
                            </ContentView>
                        </Border>
                    </Grid>
                </Grid>
                <Label
                    Grid.Row="2"
                    Margin="10,0,10,0"
                    FontFamily="GothamBold"
                    FontSize="{StaticResource FontSizeM}"
                    HorizontalOptions="Start"
                    IsVisible="{Binding IsShowError, Mode=TwoWay}"
                    Text="Lỗi"
                    TextColor="{toolkit:AppThemeResource PrimaryColor}"
                    VerticalOptions="Center" />
                <Label
                    Grid.Row="4"
                    FontFamily="GothamBold"
                    FontSize="{StaticResource FontSizeM}"
                    HorizontalOptions="Start"
                    HorizontalTextAlignment="Center"
                    Text="{i18n:Translate Chat_New_Match_Title}"
                    TextColor="{toolkit:AppThemeResource PrimaryColor}" />
                <CollectionView
                    x:Name="userChatCollection"
                    Grid.Row="6"
                    HorizontalScrollBarVisibility="Never"
                    ItemTemplate="{StaticResource userChatTempateSelector}"
                    ItemsSource="{Binding Users}">
                    <CollectionView.ItemsLayout>
                        <LinearItemsLayout ItemSpacing="20" Orientation="Horizontal" />
                    </CollectionView.ItemsLayout>
                </CollectionView>
                <Label
                    Grid.Row="8"
                    FontFamily="GothamBold"
                    FontSize="{StaticResource FontSizeM}"
                    HorizontalOptions="Start"
                    HorizontalTextAlignment="Center"
                    Text="{i18n:Translate Chat_Message_Title}"
                    TextColor="{toolkit:AppThemeResource PrimaryColor}" />
                <RefreshView
                    x:Name="refreshView"
                    Grid.Row="10"
                    Command="{Binding ReloadListCommand}"
                    IsRefreshing="{Binding IsRefreshing}"
                    ZIndex="0">
                    <sho:CollectionView
                        x:Name="chatMessageItemCollection"
                        AutoDisconnectHandler="False"
                        CollectionLayout="Vertical"
                        ItemHeight="80"
                        ItemSpacing="10"
                        ItemTemplate="{StaticResource ChatMessageItemTemplate}"
                        ItemsSource="{Binding UserChats, Mode=OneWay}"
                        MinimumHeightRequest="10"
                        TapCommand="{Binding UserChatItemClickedCommand}" />
                </RefreshView>
                <Grid
                    x:Name="Overlay"
                    Grid.Row="1"
                    Grid.RowSpan="10"
                    BackgroundColor="Transparent"
                    IsVisible="{Binding IsVisibleFilterContainer, Mode=TwoWay}"
                    ZIndex="99" />
            </Grid>
        </Grid>
    </base:BasePage.Content>
</base:BasePage>